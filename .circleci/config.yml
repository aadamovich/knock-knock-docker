version: 2.1

commands:
  build-docker-image:
    parameters:
      file:
        type: string
        default: Dockerfile
    steps:
      - run: docker build -f << parameters.file >> .


jobs:
  build-client:
    machine: true
    steps:
      - checkout
      - run: env
      - run: sleep 20000
      - run: "curl -v -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/project/github/aadamovich/knock-knock-docker"
      - run: "curl -s -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/job | jq -r ."
      # - run: "curl -v -L -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X POST https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/cancel"
      - run: "curl -s -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/workflow/${CIRCLE_WORKFLOW_ID}/job | jq -r \".items[] | select(.id == \\\"${CIRCLE_WORKFLOW_JOB_ID}\\\") | .job_number\" | tee .job_number"
      - run: "cat .job_number"
      - run: "export CIRCLE_JOB_NUMBER=$(cat .job_number)"
      - run: "curl -v -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/project/github/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}"
      - run: "curl -v -L -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/project/github/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}"
      - run: "curl -v -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/project/gh/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}"
      - run: "curl -v -L -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X GET https://circleci.com/api/v2/project/gh/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}"
      - run: "curl -v -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X POST https://circleci.com/api/v2/project/github/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}/cancel"
      - run: "curl -v -u ${CIRCLE_TOKEN}: -H 'Accept: application/json' -X POST https://circleci.com/api/v2/project/gh/aadamovich/knock-knock-docker/job/${CIRCLE_JOB_NUMBER}/cancel"
      - build-docker-image: { file: "Dockerfile.client" }
  build-server:
    machine: true
    steps:
      - checkout
      - build-docker-image:
          file: Dockerfile.server
  deploy-to-prod:
    machine: true
    steps:
      - checkout
      - run: echo Yes
  debug:
    machine: true
    steps:
      - checkout
      - run: echo debug


workflows:
  version: 2
  my_flow:
    jobs:
      - build-client
#       - build-server
#   my_flow2:
#     jobs:
#       - build-server
#       - build-client:
#           requires:
#             - build-server

#   my_flow3:
#     jobs:
#       - build-client
#       - build-server
#       - approve-deployment:
#           type: approval
#           requires:
#             - build-server
#             - build-client
#       - deploy-to-prod:
#           requires:
#             - approve-deployment
